## Lucy-完成A股/H股组合分别估值概述
交易室需要将同一个产品在A股和港股的估值和资产进行分离，以前的产品只有一个单位净值，分离后将有A股单位净值和港股单位净值，以及对应的A股资产净值和港股资产净值。因此建立了包含A股/H股估值数据以及计算中间数据的表FundAssetDetailInfo
## 数据来源
产品当天的单位净值数据来自于基金组合情况表（FundPortfolio），当月累计收益来自于凭证表（FA_Voucher），其中
- A股数据对应的科目有：
1. 股票投资610101及其子科目 
2. 股票投资收益611101及其子科目 
3. 上交所股利收入61119901及其子科目 
4. 深交所股利收入61119903及其子科目
- H股数据对应的科目有：
1. 沪港通610106及其子科目 
2. 深港通610107及其子科目 
3. 沪港通股票投资收益611111及其子科目 
4. 深港通股票投资收益611112及其子科目 
5. 股利收入_港股通61119911及其子科目 
6. 股利收入_港股通_深圳61119912及其子科目。
产品当天在A股和H股市值来自于基金持仓-来自估值系统（FA_FundPosition）

##	实现方式及算数公式
* ### 实现方式
执行数据导入程序主体分为四个接口来进行数据的导入，接口如下图所示: 
分别为：
1. TotalInsertDataSingle 某产品全量插入A股/H股单独估值数据，接口参数有
* fInerCode：必传。表示单对某一产品进行全量的数据导入任务
* endDate，可传。传入则表示导入从该基金成立日至endDate这一区间的数据。若不传入则导入该基金在估值表存在估值的所有日期的数据。
2. TotalInsertDataAll 全部产品全量插入A股/H股估值数据，接口参数有
* endDate：可传。传入则表示导入所有基金从当前基金成立日至endDate这一区间的数据。若不传入则导入所有基金在估值表存在估值的所有日期的数据。
#### 注意：
由于执行该操作数据量比较大，有时当数据库负载比较大时，程序执行完后在数据库端还会执行数据Insert操作，此时表FundAssetDetailInfo可能处于被锁状态，执行其他Insert操作时会报进程冲突的错误，建议执行该操作后等几分钟，确认数据已经全部可查询时再去执行其他数据导入操作。
3. IncrementInsertDataSingle 单个产品增量插入A股/H股估值数据，接口参数有
* finnerCode：必传。表示单对某一产品进行增量的数据导入任务
* date，可传。传入则表示导入该基金在date这天的估值数据，原先有则会覆盖。若不传入则导入该基金当天前一天的估值数据。
4. IncrementInsertDataAll 全部产品增量插入A股/H股估值数据，接口参数有
* Date，可传。传入则表示导入该基金在date这天的估值数据，原先有则会覆盖。若不传入则导入该基金当天前一天的估值数据。
* ### 算数公式
1. 计算A股/H股单位净值
- 日期 = 估值日 [FundPortfolio.FDate]
- 单位净值 = 估值表中的复权净值 [FundPortfolio.AdjNAV]
- 单位净值NAV = 估值表中的复权净值 [FundPortfolio.AdjNAV]
- 净值涨跌幅 = 单位净值NAV(当天) / 单位净值NAV(前天) - 1
- 净值 = 估值表中的AUM [FundPortfolio.AUM]
- 累计收益变动基准 = 净值（前天） × 净值涨跌幅
- 若为月初第一个估值日，则
    * A股当日收益 = A股当月累计收益
    * H股当日收益 = H股当月累计收益
- 否则（即月中某一天）
    * A股当日收益 = A股当月累计收益（当天）- A股当月累计收益（前天）
    * H股当日收益 = H股当月累计收益（当天）-H股当月累计收益（前天）
- A股收益占比 = A股当日收益 / 累计收益变动
- H股收益占比 = H股当日收益 / 累计收益变动
- 若A股当日收益与H股当日收益反向，则
    * A股累计收益变动 = A股当日收益 + (累计收益变动基准-（A股当日收益 + H股当日收益）× 0.51)  --0.51是参数，可在元数据中配置相应基金的该参数，默认0.51
    * H股累计收益变动 = H股当日收益 + (累计收益变动基准-（A股当日收益 + H股当日收益）× 0.49)  --0.49是参数，可在元数据中配置相应基金的该参数，默认0.49
- 否则（即A股当日收益与H股当日收益同向）
    * A股累计收益变动 = 累计收益变动基准 × A股收益占比
    * H股累计收益变动 = 累计收益变动基准 × H股收益占比
- A股净值 = 净值 × 0.51
- H股净值 = 净值 × 0.49
- A股净值变动 = A股累计收益变动 / A股净值（前天）
- H股净值变动 = H股累计收益变动 / H股净值（前天）
- A股单位净值 = A股单位净值（前天） × （1 + A股净值变动）
- H股单位净值 = H股单位净值（前天） × （1 + H股净值变动）
- 额外需计算的量
- 累计收益 = 前天累计收益 + 累计收益变动基准
- A股累计收益 = 上月月末的A股累计收益 + A股当月累计收益
- H股累计收益 = 上月月末的H股累计收益 + H股当月累计收益
- 累计收益合计 = A股累计收益 + H股累计收益
- 累计收益差值 = 累计收益合计 – 累计收益
- 累计收益变动 = 当天累计收益合计 – 前天累计收益合计
- A股占比 = A股市值/净值
- H股占比 = H股市值/净值
- A股资产总净值 = 基金份额 × 0.51 × A股单位净值
- H股资产总净值 = 基金份额 × 0.49 × H股单位净值
- 现金（A股）= A股资产总净值 – A股市值
- 现金（H股）= H股资产总净值 – H股市值
## 结语   
A股/H股数据导入后，还需做前端显示页面来出报表。
