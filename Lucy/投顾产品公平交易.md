## Lucy系统将投顾产品纳入公平交易概述
因有新业务（投顾业务），公司需将外部的投顾产品也纳入Lucy系统交易价差分析模块。业务需求是将这些投顾产品与公司产品一起进行交易价差分析，由于外部投顾产品信息之前不存在于我们的数据库中，因此为实现该业务建立了与公司产品结构相似的投顾产品数据表，而对于投顾产品的交易指令，也建立了投顾产品的交易指令表。 
其中交易价差分析模块包含三部分：同向/反向交易价差，同日反向交易单边量比，T检验，如下所示。

![结果1](..\Lucy\投顾产品公平交易Img\1.png)

## 交易价差分析原有逻辑
- ### 同向/反向交易价差计算逻辑
1. 获取所选择日期的1/3/5个交易日内的存在成交量的交易指令 
2. 当两个不同产品在这一期间内交易同一只股票或债券时，计算交易价差比例
其中：交易价差比例 = 交易价差*成交数量（两个产品中较小者）/ 成交金额 
交易价差 = 两个产品在这一期间内同一股票/债券各自的交易均价的差，取绝对值
查询页面如下所示。

![结果2](..\Lucy\投顾产品公平交易Img\2.png)
 
- ### 同日反向交易单边量比
1. 获取查询日期当日存在成交量的交易指令
2. 再从以上数据集中获取存在双向交易(买入/卖出)的股票或债券代码
3. 对于存在双向交易的股票或债券，查找是哪些产品进行了交易，计算相应的成交均价，交易数量，以及单边量比。
其中：单边量比 = 同一股票/债券在当天交易量较少的产品的交易量 / 该证券当日市场成交量
查询页面及结果如下所示（数据为假数据）：

![结果3](..\Lucy\投顾产品公平交易Img\3.png)

- ### T检验
1. 获取所选择开始日期和结束日期内存在成交量的交易指令
2. 根据所选择的几日（1/3/5日）内同向交易，计算两个不同产品在1/3/5日内同向交易的次数
3. 对于1/3/5日内交易次数大于30次的进行T检验，根据计算出的t统计量与相应置信度的t统计量进行比较，视结果给出是否违反假设。
其中：T检验即为统计学中的T检验方法，计算公式为：用于对两个投资组合的交易价差进行分析，检验其是否具有显著的差异。两组合间的同向交易长期看价差均值应趋向于0，即显著性检验的零假设为溢价率均值为0，备选假设为溢价率均值不等于0。
查询数据如下图所示：

![结果4](..\Lucy\投顾产品公平交易Img\4.png)
同时也能拿到查询期间内不同产品中存在同一股票同向交易的价差明细，如下图所示：

![结果5](..\Lucy\投顾产品公平交易Img\5.png)

## 将投顾产品纳入交易价差模块实现
如上所述，投顾产品的基本信息和交易指令表分别是IAProductBaseInfo（基本信息表），IATradeInstruction（交易指令表），表结构与FundBaseInfo(产品基本信息表)，TradeInstruction（交易指令表类似），为将投顾产品纳入交易价差分析，只需将投顾产品的交易指令与浙商产品的交易指令合并，去计算对应的同向/反向交易价差，同日反向交易单边量比，T检验。对应的计算逻辑不变，只是初始数据集包含了投顾产品的交易指令信息。

## 结语
现在还需要从OA系统中导入投顾产品的基本信息，以及每天的交易指令。




